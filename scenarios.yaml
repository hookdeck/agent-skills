# Agent Scenario Testing Configuration
# Used by: tools/agent-scenario-tester (npx tsx tools/agent-scenario-tester/src/index.ts run <scenario> <framework>)
#
# Usage:
#   npx tsx tools/agent-scenario-tester/src/index.ts run receive-webhooks express
#   npx tsx tools/agent-scenario-tester/src/index.ts run receive-provider-webhooks nextjs --provider stripe
#   npx tsx tools/agent-scenario-tester/src/index.ts list

frameworks:
  - express
  - nextjs
  - fastapi

scenarios:
  - name: receive-webhooks
    displayName: Receive Webhooks (basic)
    description: >
      Basic Hookdeck setup: create connection, build handler with
      Hookdeck signature verification, listen locally, document iterate workflow.
    stages:
      - setup
      - scaffold
      - listen
      - iterate
    prompt: >
      Set up Hookdeck for my {framework} app to receive webhooks.
      Create a webhook handler at /webhooks that verifies the
      Hookdeck signature. Use hookdeck listen for local development.
      Assume the user has already received at least one webhook (e.g. by running
      hookdeck listen and sending a test request to the Source URL). In the
      README or docs, add a section that explains how to inspect and retry:
      list requests, then events, then attempts (in that order), and how to
      retry a failed event using the CLI. If you use the installed event-gateway
      skill, say which file you referenced (e.g. verification-code.md,
      02-scaffold.md, 04-iterate.md).
    evaluation:
      - stage: Skill discovery
        points: 2
        checks:
          - Agent read SKILL.md or referenced event-gateway skill
          - Agent followed staged workflow order
      - stage: Stage 01 - Setup
        points: 3
        checks:
          - CLI installation referenced
          - hookdeck listen or hookdeck login used
          - Connection creation attempted
      - stage: Stage 02 - Scaffold
        points: 5
        checks:
          - Webhook handler created
          - Hookdeck signature verification implemented
          - Uses HMAC SHA-256 with base64 encoding
          - Raw body preserved for verification
          - Returns 200 on valid signature, 401 on invalid
      - stage: Stage 03 - Listen
        points: 3
        checks:
          - hookdeck listen <port> with correct port
          - --path flag used if endpoint is not /
          - Source URL noted or referenced
      - stage: Stage 04 - Iterate
        points: 2
        checks:
          - References 04-iterate, cli-workflows, or monitoring-debugging
          - Documents hookdeck gateway request/event/attempt list and retry
          - Request then event then attempt order in documentation
      - stage: Code quality
        points: 2
        checks:
          - Idiomatic to framework
          - No syntax errors or obvious bugs

  - name: investigate-delivery-health
    displayName: Investigate delivery health (metrics usage)
    description: >
      Documentation-only scenario: assume traffic exists; ask the agent how to
      get a "performance picture" from the CLI. Verifies the agent discovers and
      uses hookdeck gateway metrics without the prompt mentioning metrics.
    stages:
      - iterate
    prompt: >
      Assume the user has been receiving webhooks via Hookdeck for the past week.
      They want to understand how delivery has been performing: e.g. how many
      events succeeded vs failed, whether there's a backlog, and if latency has
      been acceptable. In the README or in your reply, list the exact CLI
      commands (or steps) you would use to get that picture from the terminal,
      without opening the Dashboard. If you use the installed event-gateway
      skill, say which file you referenced.
    evaluation:
      - stage: Stage - Investigate delivery
        points: 3
        checks:
          - References monitoring-debugging or metrics material
          - Uses metrics CLI (hookdeck gateway metrics or equivalent)
          - At least one concrete metrics command with time range and measures

  - name: receive-provider-webhooks
    displayName: Receive Provider Webhooks (with composition)
    description: >
      Full integration: Hookdeck + provider-specific webhook handling.
      Tests composition of event-gateway skill with webhook-skills.
    stages:
      - setup
      - scaffold
      - listen
    providerDefault: stripe
    providers:
      - stripe
      - github
      - shopify
    prompt: >
      Set up Hookdeck for my {framework} app to receive {Provider}
      webhooks. Create a handler that verifies the Hookdeck signature
      and handles {events} events. Use hookdeck listen for local
      development. If you use the installed skill(s), say which file(s)
      you referenced (e.g. verification-code.md, 02-scaffold.md).
    providerConfig:
      stripe:
        events:
          - payment_intent.succeeded
          - checkout.session.completed
      github:
        events:
          - push
          - pull_request
      shopify:
        events:
          - orders/create
          - orders/paid
    evaluation:
      - stage: Skill discovery
        points: 2
        checks:
          - Agent read SKILL.md or referenced event-gateway skill
          - Agent followed staged workflow order
      - stage: Stage 01 - Setup
        points: 3
        checks:
          - CLI installation referenced
          - hookdeck listen or hookdeck login used
          - Connection creation attempted
      - stage: Stage 02 - Scaffold
        points: 5
        checks:
          - Webhook handler created
          - Hookdeck signature verification implemented
          - Raw body preserved; proper status codes
          - Provider-specific verification if applicable
      - stage: Stage 03 - Listen
        points: 3
        checks:
          - hookdeck listen <port> with correct port
          - Source URL or connection noted
      - stage: Composition
        points: 2
        checks:
          - Referenced webhook-skills provider skill
          - Correct provider verification
      - stage: Code quality
        points: 2
        checks:
          - Idiomatic to framework
          - No syntax errors or obvious bugs
